---
title: "quarterly-processing"
output: html_document
date: '2022-06-29'
---

```{r Load Packages, echo = FALSE, warning = FALSE, message = FALSE}
# # Load packages -----------------------------------------------------------------------------------
suppressMessages({
  # memory.limit(size = 8000000)
  library(readxl)
  library(writexl)
  library(plyr)
  library(dplyr)
  library(data.table)
  library(zoo)
  library(shiny)
  library(shinydashboard)
  library(shinydashboardPlus)
  library(shinyWidgets)
  library(htmlwidgets)
  library(lubridate)
  library(tcltk)
  library(tidyverse)
  library(plotly)
  library(knitr)
  library(kableExtra)
  library(leaflet)
  library(grid)
  library(gridExtra)
  library(eeptools)
  library(ggQC)
  library(zipcodeR)
  library(utils)
  library(scales)
  library(chron)
  library(bupaR)
  library(shiny)
  library(DT)
  library(DiagrammeR)
  library(shinyalert)
  library(edeaR)
  library(processmapR)
  library(processmonitR)
  library(processanimateR)
  library(tidyr)
  library(lubridate)
  library(RColorBrewer)
  library(DiagrammeR)
  library(ggplot2)
  library(leaflet)
  library(readr)
  library(highcharter)
  library(ggforce) # for 'geom_arc_bar'
  library(packcircles) # for packed circle graph
  library(viridis)
  library(ggiraph)
  library(treemapify)
  library(treemap)
  library(broom)
  library(extrafont)
  library(tis) # for US holidays
  library(vroom)
  library(sjmisc)
  library(tools)
  library(here)
  library(shinyBS)
  library(shinyscreenshot)
  library(fasttime)
  library(shinycssloaders)
  library(feather)
  # library(zipcodeR)
  library(formattable)
  library(shinyjs)
  library(janitor)
  library(patchwork)
  library(flexdashboard)
  # library(tidyverse)
  # library(viridis)
  # library(hrbrthemes)
  # library(plotly)
  # install.packages("bsts")
  library(bsts)
  library(reactable)
  # install.packages("reactablefmtr")
  library(reactablefmtr)
  library(svDialogs)
  library(openxlsx)
  library(flextable)
  library(officedown)
  library(officer)
  library(magrittr)
  library(webshot) 
  library(png)
  library(ggh4x)
  library(RODBC)
  library(DBI)
  library(odbc)
})


```


```{r Global Functions, echo = FALSE, warning = FALSE, message = FALSE}

'%!in%' <- function(x,y)!('%in%'(x,y)) # Does not include
not_all_na <- function(x) all(!is.na(x)) # Exclude columns with All NAs

```


```{r Processing Variables, echo = FALSE, warning = FALSE, message = FALSE}

quarter_start <- "2021-01-01"
quarter_end <- "2022-10-01"

```


```{r Import Raw Scheduling Data, echo = FALSE, warning = FALSE, message = FALSE}

scheduling_data_raw <- readRDS("/nfs/data/Applications/Ambulatory/Data_Updated/historical_data.rds")
# scheduling_data_raw <- readRDS("/nfs/data/Applications/Ambulatory/Data/historical_data.rds")

scheduling_data_raw <- readRDS(file.choose())

scheduling_data_raw <- scheduling_data_raw %>% 
  mutate(Appt.WeekNum = lubridate::epiweek(Appt.DateYear),
         Appt.YearQtr = as.yearqtr(Appt.DTTM),
         Appt.Made.YearQtr = as.yearqtr(Appt.Made.DTTM),
         Visit.Method  = case_when(Visit.Method == "IN PERSON" ~ 'IN PERSON',TRUE ~ 'TELEHEALTH'),
         New.PT2 = case_when(New.PT2 == "New" ~ 'New',TRUE ~ 'Established'),
         New.PT3 = case_when(New.PT3 == "TRUE" ~ 'New',TRUE ~ 'Established'),
         Appt.Made.DateYear = as.Date(Appt.Made.DTTM, format="%Y-%m-%d"),
         Appt.Made.MonthYear = format(as.Date(Appt.Made.DTTM, format="%m/%d/%Y"), "%Y-%m"),
         Appt.Made.Year = format(as.Date(Appt.Made.DTTM, format="%m/%d/%Y"), "%Y"),
         Appt.Made.WeekNum = as.numeric(strftime(Appt.Made.DTTM, format = "%V")),
         Session = ifelse(as.integer(sub(':.*', '', Time)) >= 12, 'PM', 'AM') )

obgyn <- scheduling_data_raw %>%
  filter(Campus.Specialty %in% c("OB/Gyn"))

 
# Master Ambulatory Mapping 
# master_amb_mapping <- read_excel(file.choose())
master_amb_mapping <- as.data.frame(read_excel("/nfs/data/Applications/Ambulatory/master_amb_mapping.xlsx"))
# master_amb_mapping <- read_excel(file.choose())

## Departments Managed by Department vs. Site
scheduling_data_raw$Managed <- master_amb_mapping$`Managed by Department or Site`[match(scheduling_data_raw$DepartmentId, master_amb_mapping$DepartmentId)]
scheduling_data_raw <- scheduling_data_raw %>%
  # mutate(Managed = ifelse(is.na(Managed), "Department", Managed)) %>%
  filter(Managed == "Department")

## Manual Mapping of Specialty and Site 
scheduling_data_raw$Campus.Specialty <- master_amb_mapping$Specialty[match(scheduling_data_raw$DepartmentId, master_amb_mapping$DepartmentId)]

scheduling_data_raw$Campus <- master_amb_mapping$Site[match(scheduling_data_raw$DepartmentId, master_amb_mapping$DepartmentId)]

```


```{r Import Raw Slot Data, echo = FALSE, warning = FALSE, message = FALSE}

# slot_data_raw <- as.data.frame(readRDS(file.choose())) %>%
#   filter(!is.na(Campus)) %>%
#   filter(Campus %in% c("NETWORK","MSM","MSH-MSDFP","ONCOLOGY","MSW","MSBI","MSUS","MSH- AMBULATORY CARE","MSDD")) 
# 
# slot_data_raw <- slot_data_raw %>%
#   mutate(Appt.WeekNum = lubridate::epiweek(Appt.DateYear),
#          Appt.YearQtr = as.yearqtr(Appt.DateYear),
#          Session = ifelse(as.integer(sub(':.*', '', Appt.TM.Hr)) >= 12, 'PM', 'AM'))

# saveRDS(slot_data_raw %>% filter(Appt.YearQtr == "2022 Q2"), "slot_data_2022Q2.rds")

```


```{r Utilization Data Processing, echo = FALSE, warning = FALSE, message = FALSE}

# # Create Utilizaiton Data Raw  -------------------------------------------------
# ## Function for formatting date and time by hour
# system_date <- function(time){
#   result <- as.POSIXct(paste0(as.character(Sys.Date())," ",time), format="%Y-%m-%d %H:%M:%S")
#   return(result)
# }
# 
# util.function <- function(time, df){
#   result <- ifelse(system_date(time) %within% df$time.interval == TRUE,
#                    ifelse(difftime(df$Appt.End.Time, system_date(time), units = "mins") >= 60, 60,
#                           as.numeric(difftime(df$Appt.End.Time, system_date(time), units = "mins"))),
#                    ifelse(floor_date(df$Appt.Start.Time, "hour") == system_date(time),
#                           ifelse(floor_date(df$Appt.End.Time, "hour") == system_date(time),
#                                  difftime(df$Appt.End.Time, df$Appt.Start.Time, units = "mins"),
#                                  difftime(system_date(time) + 60*60, df$Appt.Start.Time, units = "mins")), 0))
#   return(result)
# }
# 
# 
# ## Pre-process Utilization by Hour based on Scheduled Appointment Times --------------------------------------------------
# data.hour.scheduled <- scheduling_data_raw %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Appt.DateYear <= max(Appt.Made.DTTM))
# 
# data.hour.scheduled$actual.visit.dur <- data.hour.scheduled$Appt.Dur * 1.2 # 20% Adjustment Factor
# 
# data.hour.scheduled$Appt.Start <- as.POSIXct(data.hour.scheduled$Appt.DTTM, format = "%H:%M")
# data.hour.scheduled$Appt.End <- as.POSIXct(data.hour.scheduled$Appt.Start + data.hour.scheduled$Appt.Dur*60, format = "%H:%M")
# 
# data.hour.scheduled$Appt.Start.Time <- as.POSIXct(paste0(Sys.Date()," ", format(data.hour.scheduled$Appt.Start, format="%H:%M:%S")))
# data.hour.scheduled$Appt.End.Time <- as.POSIXct(paste0(Sys.Date()," ", format(data.hour.scheduled$Appt.End, format="%H:%M:%S")))
# 
# data.hour.scheduled$time.interval <- interval(data.hour.scheduled$Appt.Start.Time, data.hour.scheduled$Appt.End.Time)
# 
# data.hour.scheduled$`00:00` <- util.function("00:00:00", data.hour.scheduled)
# data.hour.scheduled$`01:00` <- util.function("01:00:00", data.hour.scheduled)
# data.hour.scheduled$`02:00` <- util.function("02:00:00", data.hour.scheduled)
# data.hour.scheduled$`03:00` <- util.function("03:00:00", data.hour.scheduled)
# data.hour.scheduled$`04:00` <- util.function("04:00:00", data.hour.scheduled)
# data.hour.scheduled$`05:00` <- util.function("05:00:00", data.hour.scheduled)
# data.hour.scheduled$`06:00` <- util.function("06:00:00", data.hour.scheduled)
# data.hour.scheduled$`07:00` <- util.function("07:00:00", data.hour.scheduled)
# data.hour.scheduled$`08:00` <- util.function("08:00:00", data.hour.scheduled)
# data.hour.scheduled$`09:00` <- util.function("09:00:00", data.hour.scheduled)
# data.hour.scheduled$`10:00` <- util.function("10:00:00", data.hour.scheduled)
# data.hour.scheduled$`11:00` <- util.function("11:00:00", data.hour.scheduled)
# data.hour.scheduled$`12:00` <- util.function("12:00:00", data.hour.scheduled)
# data.hour.scheduled$`13:00` <- util.function("13:00:00", data.hour.scheduled)
# data.hour.scheduled$`14:00` <- util.function("14:00:00", data.hour.scheduled)
# data.hour.scheduled$`15:00` <- util.function("15:00:00", data.hour.scheduled)
# data.hour.scheduled$`16:00` <- util.function("16:00:00", data.hour.scheduled)
# data.hour.scheduled$`17:00` <- util.function("17:00:00", data.hour.scheduled)
# data.hour.scheduled$`18:00` <- util.function("18:00:00", data.hour.scheduled)
# data.hour.scheduled$`19:00` <- util.function("19:00:00", data.hour.scheduled)
# data.hour.scheduled$`20:00` <- util.function("20:00:00", data.hour.scheduled)
# data.hour.scheduled$`21:00` <- util.function("21:00:00", data.hour.scheduled)
# data.hour.scheduled$`22:00` <- util.function("22:00:00", data.hour.scheduled)
# data.hour.scheduled$`23:00` <- util.function("23:00:00", data.hour.scheduled)
# 
# # Data Validation
# data.hour.scheduled$sum <- rowSums(data.hour.scheduled[,which(colnames(data.hour.scheduled)=="00:00"):which(colnames(data.hour.scheduled)=="23:00")])
# data.hour.scheduled$actual <- as.numeric(difftime(data.hour.scheduled$Appt.End.Time, data.hour.scheduled$Appt.Start.Time, units = "mins"))
# data.hour.scheduled$comparison <- ifelse(data.hour.scheduled$sum ==data.hour.scheduled$actual, 0, 1)
# data.hour.scheduled <- data.hour.scheduled %>% filter(comparison == 0)
# 
# # Format utilization
# data.hour.scheduled$util.type <- "scheduled"
# 
# timeOptionsHr_filter <- c("07:00","08:00","09:00",
#                           "10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00",
#                           "20:00") ## Time Range by Hour Filter
# 
# utilization.data <- data.hour.scheduled %>%
#   dplyr::select(Campus, Campus.Specialty, Department, Resource, Provider,
#                 Visit.Method, Appt.Type, Appt.Status,
#                 Appt.DateYear, Appt.MonthYear, Appt.Year, Appt.YearQtr, Appt.Week, Appt.Day, Appt.TM.Hr, Session,
#                 timeOptionsHr_filter, sum, comparison, NPI)
# 
# # Save Processed Utilization Data Raw on Server --------------------------------
# # saveRDS(utilization.data, "/nfs/data/Applications/Ambulatory/Quarterly_Data/full_utilization_data.rds")
# 
# saveRDS(utilization.data, "utilization_data_2022Q2.rds")

```


```{r Import Full Utilization Data, echo = FALSE, warning = FALSE, message = FALSE}

# util_data_raw <- as.data.frame(readRDS("/nfs/data/Applications/Ambulatory/Quarterly_Data/full_utilization_data.rds"))

# util_data_raw <- readRDS(file.choose())

```


```{r Epic Referrals Data, echo = FALSE, warning = FALSE, message = FALSE}

# Connect to the Server
conn1 <- dbConnect(odbc(), "Caboodle")

# Import Referrals Table
referrals <- dbGetQuery(conn1, "SELECT * FROM PRDREPORT.FullAccess.Referrals")

```


```{r Room Capacity Processing, echo = FALSE, warning = FALSE, message = FALSE}

# dept_zip_code_ref <- read_csv("/nfs/data/Applications/Ambulatory/Department_Zip_Code.csv") # Epic Department Zip Code
# visitPlan <- read_csv("/nfs/data/Applications/Ambulatory/Visit Plans.csv") # Epic Visit Plan Grouping

# Local Run --------------------------------------------------------------------
# mshs_room_capacity_grid <- readRDS(file.choose())
# pt_rooms_summary <- readRDS(file.choose())
# practice_multiple_locations <- read_excel(file.choose())
# visits_room_day_benchmarks <- read_csv(file.choose())

# dept_zip_code_ref <- read_csv("C:/Users/kweons01/Desktop/Strategic Initiatives - So Youn/Github/server-upload/Department_Zip_Code.csv")
# visitPlan <- read_csv("C:/Users/kweons01/Desktop/Strategic Initiatives - So Youn/Github/server-upload/Visit_Plans.csv")
# epic_specialty_mapping <- read_csv("C:/Users/kweons01/Desktop/Strategic Initiatives - So Youn/Github/server-upload/Epic_Specialty_Mapping.csv")

dept_zip_code_ref <- read_csv("/nfs/data/Applications/Ambulatory/Department_Zip_Code.csv")
visitPlan <- read_csv("/nfs/data/Applications/Ambulatory/Visit Plans.csv")
# epic_specialty_mapping <- read_csv("/nfs/data/Applications/Ambulatory/Epic_Specialty_Mapping.csv")

# site_dept_mapping <- unique(scheduling_data_raw[,c("Campus","Campus.Specialty","Department")])

```


```{r Schduling Data Mapping, echo = FALSE, warning = FALSE, message = FALSE}

scheduling_data_raw <- merge(scheduling_data_raw, 
                             master_amb_mapping[,c("DepartmentId","Campus.Specialty.Group","Campus.Specialty.SubGroup")], 
                             by = "DepartmentId") # Map Specialty Groups
scheduling_data_raw$Coverage <- visitPlan$VisitPlan_Group[match(scheduling_data_raw$VISITPLAN, visitPlan$VISITPLAN)] # Map Visit Plan

```


```{r Referrals Data Mapping, echo = FALSE, warning = FALSE, message = FALSE}

referrals$SentSite <- master_amb_mapping$Site[match(referrals$SentByDepID, master_amb_mapping$DepartmentId)]
referrals$SentSpecialty <- master_amb_mapping$Site[match(referrals$SentByDepID, master_amb_mapping$DepartmentId)]

referrals$ReceivedSite <- master_amb_mapping$Site[match(referrals$ReceivedByDepID, master_amb_mapping$DepartmentId)]
referrals$ReceivedSpecialty <- master_amb_mapping$Site[match(referrals$ReceivedByDepID, master_amb_mapping$DepartmentId)]

referrals <- merge(referrals, 
                   master_amb_mapping[,c("DepartmentId","Campus.Specialty.Group","Campus.Specialty.SubGroup")], 
                   by.x = "ReceivedByDepID", by.y = "DepartmentId") # Map Specialty Groups

# Referrals Data - Departments Managed by Department
referrals$Managed <- master_amb_mapping$`Managed by Department or Site`[match(referrals$ReceivedByDepID, master_amb_mapping$DepartmentId)]
referrals <- referrals %>%
  # mutate(Managed = ifelse(is.na(Managed), "Department", Managed)) %>%
  filter(Managed == "Department") %>%
  filter(ReceivedSite %in% c("NYEE","MSB","NETWORK","MSM","MSH-MSDFP","ONCOLOGY","MSW","MSBI","MSUS","MSH- AMBULATORY CARE","MSDD"))

# Appointment Status Grouping
referrals_processed <- referrals %>%
  filter(Status != "Canceled") %>%
  group_by(ReferralKey) %>%
  mutate(ApptStatusFinal = NA) %>%
  mutate(ApptStatusFinal = case_when((is.na(ApptStatusFinal) & any(AppointmentStatus %in% c("Arrived","Completed"))) ~ "Arrived"
                                     ,(is.na(ApptStatusFinal) & any(AppointmentStatus %in% c("No Show", "Left without seen"))) ~ "No Show"
                                     ,(is.na(ApptStatusFinal) & any(AppointmentStatus == "Canceled")) ~ "Canceled"
                                     ,(is.na(ApptStatusFinal) & any(AppointmentStatus %in% c("Scheduled","Confirmed"))) ~ "Scheduled"
                                     ,TRUE ~ "Pending"))

```


```{r Conversion Rate, echo = FALSE, warning = FALSE, message = FALSE}

# Referrals Conversion RAte
monthly_referral_vol <- referrals_processed %>%
  group_by(Campus.Specialty.Group, Campus.Specialty.SubGroup, ReceivedSite, ReceivedByDept, StartInstant, ApptStatusFinal) %>%
  summarise(total = n()) %>%
  mutate(Received.DateYear = as.Date(StartInstant, format="%Y-%m-%d"),
         Received.MonthYear = format(Received.DateYear, "%Y-%m"), ## Create month - year column
         Received.Year = format(Received.DateYear, "%Y"), ## Create year column
         Received.Month = format(Received.DateYear, "%b"), ## Create month colunm
         Received.YearQtr = as.yearqtr(Received.DateYear)) %>%
  group_by(ReceivedSite, Campus.Specialty.Group, Campus.Specialty.SubGroup, Received.Year, Received.YearQtr, Received.Month, ApptStatusFinal) %>%
  rename(Campus = ReceivedSite) %>%
  summarise(total = n())


# Referrals Wait Time
# referral_waitTime_quarter <- referrals %>%
#   dplyr::select(Campus, Campus.Specialty.Group, Campus.Specialty.SubGroup, ReceivedBySite, ReceivedByDept, EncounterEpicCsn, AppointmentStatus, 
#                 StartInstant, CreationToFirstEncounterDate, CreationToScheduledDate) %>%
#   filter(!is.na(AppointmentStatus)) %>%
#   mutate(Received.DateYear = as.Date(StartInstant, format="%Y-%m-%d"),
#          Received.MonthYear = format(Received.DateYear, "%Y-%m"), ## Create month - year column
#          Received.Year = format(Received.DateYear, "%Y"), ## Create year column
#          Received.Month = format(Received.DateYear, "%b"), ## Create month colunm
#          Received.YearQtr = as.yearqtr(Received.DateYear)) %>%
#   group_by(Campus, Campus.Specialty.Group, Campus.Specialty.SubGroup, Received.Year, Received.YearQtr) %>%
#   summarise(waitTime = median(CreationToScheduledDate, na.rm = TRUE))
  


```


```{r Volume Tables, echo = FALSE, warning = FALSE, message = FALSE}

# Volume Tables ----------------------------------------------------------------
## Arrived monthly volume by Campus, Campus.Specialty, Department, Appt.YearQtr. Appt.MonNum, Appt.Month, Visit.Method, monthly_vol
monthly_vol <- scheduling_data_raw %>%
  filter(Appt.DateYear >= quarter_start & Appt.DateYear < quarter_end) %>%
  filter(!is.na(Campus)) %>%
  filter(Campus %in% c("NYEE","MSB","NETWORK","MSM","MSH-MSDFP","ONCOLOGY","MSW","MSBI","MSUS","MSH- AMBULATORY CARE","MSDD")) %>%
  filter(Appt.Status == "Arrived") %>%
  mutate(Appt.MonNum = as.numeric(strftime(Appt.DateYear, format = "%m")),
         Appt.Month = strftime(Appt.DateYear, format = "%b")) %>%
  group_by(Campus, Campus.Specialty.Group, Campus.Specialty.SubGroup, Department, Appt.YearQtr, Appt.MonNum, Appt.Month, Visit.Method) %>%
  summarise(monthly_vol = n())
# # Merge with Rad Onc and Radiology Data
# monthly_vol <- bind_rows(monthly_vol, rad_radOnc_data)
monthly_vol <- monthly_vol %>%
  # dplyr::select(-Month) %>%
  pivot_wider(
    names_from = Visit.Method,
    values_from = monthly_vol,
    values_fill=list(monthly_vol=0)
  ) %>%
  mutate(Total = sum(`IN PERSON`, TELEHEALTH)) %>%
  pivot_longer(
    8:10,
    names_to = "Visit.Method",
    values_to = "monthly_vol"
  )

## Arrived quarterly volume by Campus.Specialty, Appt.YearQtr, dept_zip_code, lat, lang, total_vol
vol_zip_code <- scheduling_data_raw %>%
  filter(Appt.DateYear >= quarter_start & Appt.DateYear < quarter_end) %>%
  filter(!is.na(Campus)) %>%
  filter(Campus %in% c("NYEE","MSB","MSM","MSH-MSDFP","ONCOLOGY","MSW","MSBI","MSUS","MSH- AMBULATORY CARE")) %>%
  filter(Appt.Status == "Arrived") 


dept_zip_code_ref$`Address Zip Code` <- gsub("\\-.*","",dept_zip_code_ref$`Address Zip Code`) # Remove trailing zip codes (anything after first 5-digit zip code)
vol_zip_code$dept_zip_code <- dept_zip_code_ref$`Address Zip Code`[match(vol_zip_code$Department, dept_zip_code_ref$`Department Name`)]

coordinates <- geocode_zip(vol_zip_code$dept_zip_code)
vol_zip_code <- merge(vol_zip_code, coordinates, by.x = c("dept_zip_code"), by.y = c("zipcode"), all.x = TRUE)
vol_zip_code <- vol_zip_code %>%
  group_by(Campus.Specialty.Group, Campus.Specialty.SubGroup, Appt.YearQtr, dept_zip_code, lat, lng) %>%
  summarise(total_vol = n()) %>%
  mutate(dept_zip_code=factor(dept_zip_code, unique(dept_zip_code)))

```


```{r Access Tables, echo = FALSE, warning = FALSE, message = FALSE}

# Access Tables ----------------------------------------------------------------
## MSHS New Patient Wait Time Horizon ===============================================
waitTime_dist_specialty <- scheduling_data_raw %>%
  filter(Wait.Time >= 0) %>%
  filter(Appt.Made.DateYear >= quarter_start & Appt.Made.DateYear < quarter_end) %>%
  filter(Campus %in% c("NYEE","MSB","NETWORK","MSM","MSH-MSDFP","ONCOLOGY","MSW","MSBI","MSUS","MSH- AMBULATORY CARE","MSDD")) %>%
  group_by(Campus.Specialty.Group, Campus.Specialty.SubGroup, Appt.Made.YearQtr, New.PT2) %>%
  mutate(med_wait = median(Wait.Time, na.rm = TRUE)) %>%
  mutate(group = case_when(Wait.Time >= 0 & Wait.Time <=7 ~ "0-7",
                           Wait.Time >7 & Wait.Time <=14 ~ "8-14",
                           Wait.Time >14 & Wait.Time <=30 ~ "15-30",
                           TRUE ~ ">30")) %>%
  group_by(Campus.Specialty.Group, Campus.Specialty.SubGroup, Appt.Made.YearQtr, New.PT2, Visit.Method, med_wait, group) %>%
  summarise(total = n())

## MSHS New Patient Wait Time Horizon ===============================================
waitTime_dist_site <- scheduling_data_raw %>%
  filter(Wait.Time >= 0) %>%
  filter(Appt.Made.DateYear >= quarter_start & Appt.Made.DateYear < quarter_end) %>%
  filter(Campus %in% c("NYEE","MSB","NETWORK","MSM","MSH-MSDFP","ONCOLOGY","MSW","MSBI","MSUS","MSH- AMBULATORY CARE","MSDD")) %>%
  group_by(Campus.Specialty.Group, Campus.Specialty.SubGroup, Campus, Appt.Made.YearQtr, New.PT2) %>%
  mutate(med_wait = median(Wait.Time, na.rm = TRUE)) %>%
  mutate(group = case_when(Wait.Time >= 0 & Wait.Time <=7 ~ "0-7",
                           Wait.Time >7 & Wait.Time <=14 ~ "8-14",
                           Wait.Time >14 & Wait.Time <=30 ~ "15-30",
                           TRUE ~ ">30")) %>%
  group_by(Campus.Specialty.Group, Campus.Specialty.SubGroup, Campus, Appt.Made.YearQtr, New.PT2, Visit.Method, med_wait, group) %>%
  summarise(total = n())

## Median Wait Time ============================================================
### By Specialty
waitTime_mshs <- scheduling_data_raw %>%
  filter(Campus %in% c("NYEE","MSB","MSM","MSH-MSDFP","ONCOLOGY","MSW","MSBI","MSUS","MSH- AMBULATORY CARE")) %>%
  filter(Wait.Time >= 0) %>%
  filter(Appt.Made.DateYear >= quarter_start & Appt.Made.DateYear < quarter_end) %>%
  group_by(Campus.Specialty.Group, Campus.Specialty.SubGroup, Appt.Made.YearQtr, New.PT2) %>%
  summarise(med_wait = median(Wait.Time, na.rm = TRUE))

### By Specialty and Site
waitTime_site <- scheduling_data_raw %>%
  filter(Wait.Time >= 0) %>%
  filter(Campus %in% c("NYEE","MSB","NETWORK","MSM","MSH-MSDFP","ONCOLOGY","MSW","MSBI","MSUS","MSH- AMBULATORY CARE","MSDD")) %>%
  filter(Appt.Made.DateYear >= quarter_start & Appt.Made.DateYear < quarter_end) %>%
  group_by(Campus.Specialty.Group, Campus.Specialty.SubGroup, Appt.Made.YearQtr, Campus, New.PT2) %>%
  summarise(med_wait = median(Wait.Time, na.rm = TRUE))

### By Specialty and Provider
waitTime_prov <- scheduling_data_raw %>%
  filter(Wait.Time >= 0) %>%
  filter(Appt.Made.DateYear >= quarter_start & Appt.Made.DateYear < quarter_end) %>%
  filter(New.PT2 == "New") %>%
  group_by(Campus.Specialty.Group, Campus.Specialty.SubGroup, Campus, Appt.Made.YearQtr, Provider, NPI) %>%
  summarise(med_wait = as.numeric(median(Wait.Time, na.rm = TRUE)))

```


```{r Average Weekday Volume Tables, echo = FALSE, warning = FALSE, message = FALSE}
# Average Weekday Volume -------------------------------------------------------
## By Specialty, and Quarter
# vol_weekday_quarter_mshs <- scheduling_data_raw %>%
#   filter(Appt.DateYear >= quarter_start & Appt.DateYear < quarter_end) %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Appt.Day %in% c("Mon","Tue","Wed","Thu","Fri")) %>%
#   group_by(Campus.Specialty, Campus.Specialty.Group, Campus.Specialty.SubGroup, Appt.YearQtr, Appt.DateYear, Session, Visit.Method) %>%
#   summarise(daily_vol = n()) %>%
#   pivot_wider(names_from = Session,
#               values_from = daily_vol,
#               values_fill = 0) %>%
#   group_by(Campus.Specialty, Appt.YearQtr, Visit.Method) %>%
#   summarise(AM = round(mean(AM, na.rm = TRUE)),
#             PM = round(mean(PM, na.rm = TRUE)))
# vol_weekday_quarter_mshs$Day <- vol_weekday_quarter_mshs$AM + vol_weekday_quarter_mshs$PM
# vol_weekday_quarter_mshs <- vol_weekday_quarter_mshs %>%
#   pivot_longer(AM:Day,
#                names_to = "Breakdown",
#                values_to = "Value") %>%
#   pivot_wider(names_from = Visit.Method,
#               values_from = Value,
#               values_fill = 0) %>%
#   mutate(All = `IN PERSON` + TELEHEALTH) %>%
#   pivot_longer(`IN PERSON`:All,
#                names_to = "Visit.Method",
#                values_to = "Value") %>%
#    mutate(Metric = "daily_vol") 
#   
#   
# ## By Specialty, Site, and Quarter 
# vol_weekday_quarter_site <- scheduling_data_raw %>%
#   filter(Appt.DateYear >= quarter_start & Appt.DateYear < quarter_end) %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Appt.Day %in% c("Mon","Tue","Wed","Thu","Fri")) %>%
#   group_by(Campus.Specialty, Campus.Specialty.Group, Campus.Specialty.SubGroup, Campus, Appt.YearQtr, Appt.DateYear, Session, Visit.Method) %>%
#   summarise(daily_vol = n()) %>%
#   pivot_wider(names_from = Session,
#               values_from = daily_vol,
#               values_fill = 0) %>%
#   group_by(Campus.Specialty, Campus, Appt.YearQtr, Visit.Method) %>%
#   summarise(AM = round(mean(AM, na.rm = TRUE)),
#             PM = round(mean(PM, na.rm = TRUE)))
# vol_weekday_quarter_site$Day <- vol_weekday_quarter_site$AM + vol_weekday_quarter_site$PM
# vol_weekday_quarter_site <- vol_weekday_quarter_site %>%
#   pivot_longer(AM:Day,
#                names_to = "Breakdown",
#                values_to = "Value") %>%
#   pivot_wider(names_from = Visit.Method,
#               values_from = Value,
#               values_fill = 0) %>%
#   mutate(All = `IN PERSON` + TELEHEALTH) %>%
#   pivot_longer(`IN PERSON`:All,
#                names_to = "Visit.Method",
#                values_to = "Value") %>%
#    mutate(Metric = "daily_vol") 
# ## By Specialty, Site, Department and Quarter 
# vol_weekday_quarter_dept <- scheduling_data_raw %>%
#   filter(Appt.DateYear >= quarter_start & Appt.DateYear < quarter_end) %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Appt.Day %in% c("Mon","Tue","Wed","Thu","Fri")) %>%
#   group_by(Campus.Specialty, Campus.Specialty.Group, Campus.Specialty.SubGroup, Campus, Department, Appt.YearQtr, Appt.DateYear, Session, Visit.Method) %>%
#   summarise(daily_vol = n()) %>%
#   pivot_wider(names_from = Session,
#               values_from = daily_vol,
#               values_fill = 0) %>%
#   group_by(Campus.Specialty, Campus, Department, Appt.YearQtr, Visit.Method) %>%
#   summarise(AM = round(mean(AM, na.rm = TRUE)),
#             PM = round(mean(PM, na.rm = TRUE)))
# vol_weekday_quarter_dept$Day <- vol_weekday_quarter_dept$AM + vol_weekday_quarter_dept$PM
# vol_weekday_quarter_dept <- vol_weekday_quarter_dept %>%
#   pivot_longer(AM:Day,
#                names_to = "Breakdown",
#                values_to = "Value") %>%
#   pivot_wider(names_from = Visit.Method,
#               values_from = Value,
#               values_fill = 0) %>%
#   mutate(All = `IN PERSON` + TELEHEALTH) %>%
#   pivot_longer(`IN PERSON`:All,
#                names_to = "Visit.Method",
#                values_to = "Value") %>%
#    mutate(Metric = "daily_vol") 
# ## By Specialty, Site, Department, Provider, and Quarter 
# vol_weekday_quarter_prov <- scheduling_data_raw %>%
#   filter(Appt.DateYear >= quarter_start & Appt.DateYear < quarter_end) %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Appt.Day %in% c("Mon","Tue","Wed","Thu","Fri")) %>%
#   group_by(Campus.Specialty, Campus.Specialty.Group, Campus.Specialty.SubGroup, Campus, Department, Provider, Appt.YearQtr, Appt.DateYear, Session, Visit.Method) %>%
#   summarise(daily_vol = n()) %>%
#   pivot_wider(names_from = Session,
#               values_from = daily_vol,
#               values_fill = 0) %>%
#   group_by(Campus.Specialty, Campus, Department, Provider, Appt.YearQtr, Visit.Method) %>%
#   summarise(AM = round(mean(AM, na.rm = TRUE)),
#             PM = round(mean(PM, na.rm = TRUE)))
# vol_weekday_quarter_prov$Day <- vol_weekday_quarter_prov$AM + vol_weekday_quarter_prov$PM
# vol_weekday_quarter_prov <- vol_weekday_quarter_prov %>%
#   pivot_longer(AM:Day,
#                names_to = "Breakdown",
#                values_to = "Value") %>%
#   pivot_wider(names_from = Visit.Method,
#               values_from = Value,
#               values_fill = 0) %>%
#   mutate(All = `IN PERSON` + TELEHEALTH) %>%
#   pivot_longer(`IN PERSON`:All,
#                names_to = "Visit.Method",
#                values_to = "Value") %>%
#    mutate(Metric = "daily_vol") 

```


```{r Payor Mix Table, echo = FALSE, warning = FALSE, message = FALSE}

payer_mix_quarter_site <- scheduling_data_raw %>%
  filter(Appt.DateYear >= quarter_start & Appt.DateYear < quarter_end) %>%
  filter(Campus %in% c("NYEE","MSB","MSM","MSH-MSDFP","ONCOLOGY","MSW","MSBI","MSUS","MSH- AMBULATORY CARE")) %>%
  filter(Appt.Status == "Arrived") %>%
  mutate(Coverage = ifelse(is.na(Coverage),"Other",Coverage)) %>%
  group_by(Campus.Specialty.Group, Campus.Specialty.SubGroup, Campus, Appt.YearQtr, Coverage) %>%
  summarise(payer = n())


```


```{r Total Working Day Variables, echo = FALSE, warning = FALSE, message = FALSE}

# workdays_quarter <- length(unique((scheduling_data_raw %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Appt.YearQtr == "2022 Q2") %>%
#   filter(Appt.DateYear <= max(Appt.Made.DateYear)) %>%
#   filter(Appt.Day %in% c("Mon","Tue","Wed","Thu","Fri")))$Appt.DateYear))
# 
# weekdays_quarter <- scheduling_data_raw %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Appt.YearQtr == "2022 Q2") %>%
#   filter(Appt.DateYear <= max(Appt.Made.DateYear)) %>%
#   filter(Appt.Day %in% c("Mon","Tue","Wed","Thu","Fri")) %>%
#   group_by(Appt.Day, Appt.DateYear) %>%
#   summarise(days = n()) %>%
#   group_by(Appt.Day) %>%
#   summarise(days = n())

```


```{r Location Turns Utilization, echo = FALSE, warning = FALSE, message = FALSE}

# # Total Room Count by Location
# ## Get total unique room count by building address and floor
# location_room_count <- pt_rooms_summary %>%
#   group_by(`Building Address`, Floor) %>%
#   summarise(total_rooms = length(unique(Room)))
#   
# 
# # Location by Department -------------------------------------------------------
# ## Total main rooms assigned/used by campus and specialty 
# location_main_rooms <- anti_join(pt_rooms_summary, 
#                                  practice_multiple_locations[,c("Building Address","Floor","Department")])
# location_main_rooms <- location_main_rooms %>%
#   group_by(`Building Address`, Floor, Campus, Campus.Specialty, Department) %>%
#   summarise(dept_assigned_rooms = length(unique(Room)))
# 
# # location_main_rooms <- merge(location_main_rooms, location_room_count, all.x = TRUE)
# 
# ## Total sub rooms assigned/used by campus and specialty based on Practice Multiple Locations Mapping File 
# location_sub_rooms <- semi_join(pt_rooms_summary, 
#                                  practice_multiple_locations[,c("Building Address","Floor","Department")])
# location_sub_rooms <- location_sub_rooms %>%
#   group_by(`Building Address`, Floor, Campus, Campus.Specialty, Department) %>%
#   summarise(dept_assigned_rooms = length(unique(Room)))
# # 
# # location_sub_rooms <- merge(location_sub_rooms, location_room_count, all.x = TRUE)
# 
# 
# # Volume by Department ---------------------------------------------------------
# # Volume seen by departments mapped to location
# location_main_volume <- anti_join(scheduling_data_raw, 
#                                   practice_multiple_locations[,c("Department","Appt.Day","Provider","Session")])
# 
# location_main_volume <- location_main_volume %>% 
#   filter(Appt.Status == "Arrived") %>%
#   filter(Appt.YearQtr == "2022 Q2") %>%
#   filter(Appt.DateYear <= max(Appt.Made.DateYear)) %>%
#   filter(Appt.Day %in% c("Mon","Tue","Wed","Thu","Fri")) %>%
#   group_by(Campus, Campus.Specialty, Department, Appt.YearQtr, Appt.DateYear, Visit.Method, Session) %>%
#   summarise(daily_vol = n()) %>%
#   group_by(Campus, Campus.Specialty, Department, Appt.YearQtr, Visit.Method, Session) %>%
#   summarise(avg_vol = round(sum(daily_vol)/workdays_quarter)) 
#   
# 
# volume <- scheduling_data_raw %>%  filter(Appt.Status == "Arrived") %>%
#   filter(Appt.YearQtr == "2022 Q2") %>%
#   filter(Appt.DateYear <= max(Appt.Made.DateYear)) %>%
#   filter(Appt.Day %in% c("Mon","Tue","Wed","Thu","Fri")) %>%
#   summarise(total = n())
# 
# # Volume seen outside of departments mapped to location 
# location_sub_volume <- semi_join(scheduling_data_raw, 
#                                  practice_multiple_locations[,c("Department","Appt.Day","Provider","Session")])
# 
# location_sub_volume <- location_sub_volume %>% 
#   filter(Appt.Status == "Arrived") %>%
#   filter(Appt.YearQtr == "2022 Q2") %>%
#   filter(Appt.DateYear <= max(Appt.Made.DateYear)) %>%
#   filter(Appt.Day %in% c("Mon","Tue","Wed","Thu","Fri")) %>%
#   group_by(Campus, Campus.Specialty, Department, Appt.YearQtr, Appt.DateYear, Visit.Method, Session) %>%
#   summarise(daily_vol = n()) %>%
#   group_by(Campus, Campus.Specialty, Department, Appt.YearQtr, Visit.Method, Session) %>%
#   summarise(avg_vol = round(sum(daily_vol)/workdays_quarter))
# 
# 
# # Utilization by Location: Rooms and Volume Data Merge -------------------------
# location_main_util_turns <- left_join(location_main_volume, location_main_rooms,
#                             by = c("Campus","Campus.Specialty","Department"))
# 
# location_sub_util_turns <- left_join(location_sub_volume, location_sub_rooms,
#                             by = c("Campus","Campus.Specialty","Department"))
# 
# ## Merge utilization data for main and sub room assignments 
# location_util_turns_merged <- bind_rows(location_main_util_turns, location_sub_util_turns)
# # location_util_turns_merged <- location_util_turns_merged %>%
# #   group_by(Appt.YearQtr, `Building Address`, Floor, Campus, Campus.Specialty, Visit.Method, Session) %>%
# #   mutate(rooms_assigned_specialty = length(unique(Room)))
# 
# ## Merge with Visits/Room/Day Benchmark
# location_util_turns_merged$Benchmark <- visits_room_day_benchmarks$Benchmark[match(location_util_turns_merged$Campus.Specialty,
#                                                                              visits_room_day_benchmarks$Campus.Specialty)]
# 
# location_util_turns_summary <- location_util_turns_merged %>%
#   group_by(Appt.YearQtr, `Building Address`, Floor, Visit.Method, Session) %>%
#   summarise(Benchmark = round(mean(Benchmark)),
#             avg_vol = sum(avg_vol))
# location_util_turns_summary <- merge(location_util_turns_summary, location_room_count, all.x = TRUE)
# 
# location_util_turns_summary <- location_util_turns_summary %>%
#   pivot_wider(names_from = "Visit.Method",
#               values_from = "avg_vol",
#               values_fill = 0) %>%
#   mutate(ALL = `IN PERSON` + TELEHEALTH) %>%
#   pivot_longer(`IN PERSON`:ALL,
#                names_to = "Visit.Method",
#                values_to = "avg_vol") %>%
#   pivot_wider(names_from = "Session",
#               values_from = "avg_vol",
#               values_fill = 0) %>%
#   mutate(Day = AM + PM) %>%
#   pivot_longer(AM:Day,
#                names_to = "Session",
#                values_to = "avg_vol") 
# 
# 
# # location_util_turns_merged <- location_util_turns_merged %>%
# #   pivot_wider(names_from = "Visit.Method",
# #               values_from = "avg_vol",
# #               values_fill = 0) %>%
# #   mutate(ALL = `IN PERSON` + TELEHEALTH) %>%
# #   pivot_longer(`IN PERSON`:ALL,
# #                names_to = "Visit.Method",
# #                values_to = "avg_vol") %>%
# #   pivot_wider(names_from = "Session",
# #               values_from = "avg_vol",
# #               values_fill = 0) %>%
# #   mutate(Day = AM + PM) %>%
# #   pivot_longer(AM:Day,
# #                names_to = "Session",
# #                values_to = "avg_vol") 


```


```{r Location Durations Utilization, echo = FALSE, warning = FALSE, message = FALSE}

# # Utilization by Department ---------------------------------------------------------
# ## Durations completed by departments mapped to location
# location_main_util_hour <- anti_join(util_data_raw, 
#                                      practice_multiple_locations[,c("Department","Appt.Day","Provider","Session")])
# 
# location_main_util_hour <- location_main_util_hour %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Appt.YearQtr == "2022 Q2") %>%
#   filter(Appt.Day %in% c("Mon","Tue","Wed","Thu","Fri")) %>%
#   dplyr::select(Campus, Campus.Specialty, Department, Appt.YearQtr, Appt.DateYear, Appt.Day, 
#                 Visit.Method, `08:00`:`19:00`) %>%
#   pivot_longer(`08:00`:`19:00`,
#                names_to = "space_time",
#                values_to = "space_dur") %>%
#   mutate(Session = ifelse(as.integer(sub(':.*', '', space_time)) >= 12, 'PM', 'AM')) %>%
#   group_by(Campus, Campus.Specialty, Department, Appt.YearQtr, Appt.Day, 
#            Visit.Method, Session, space_time) %>%
#   summarise(total_dur = round(sum(space_dur))) 
# 
# 
# ## Durations completed outside of departments mapped to location 
# location_sub_util_hour <- semi_join(util_data_raw, 
#                                     practice_multiple_locations[,c("Department","Appt.Day","Provider","Session")])
# 
# location_sub_util_hour <- location_sub_util_hour %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Appt.YearQtr == "2022 Q2") %>%
#   filter(Appt.Day %in% c("Mon","Tue","Wed","Thu","Fri")) %>%
#   dplyr::select(Campus, Campus.Specialty, Department, Appt.YearQtr, Appt.DateYear, Appt.Day, 
#                 Visit.Method, `08:00`:`19:00`) %>%
#   pivot_longer(`08:00`:`19:00`,
#                names_to = "space_time",
#                values_to = "space_dur") %>%
#   mutate(Session = ifelse(as.integer(sub(':.*', '', space_time)) >= 12, 'PM', 'AM')) %>%
#   group_by(Campus, Campus.Specialty, Department, Appt.YearQtr, Appt.Day, 
#            Visit.Method, Session, space_time) %>%
#   summarise(total_dur = round(sum(space_dur))) 
# 
# 
# # Utilization by Location: Rooms and Volume Data Merge -------------------------
# location_main_util_hour <- left_join(location_main_util_hour, location_main_rooms,
#                             by = c("Campus","Campus.Specialty","Department"))
# 
# location_sub_util_hour <- left_join(location_sub_util_hour, location_sub_rooms,
#                             by = c("Campus","Campus.Specialty","Department"))
# 
# ## Merge utilization data for main and sub room assignments 
# location_util_dur_merged <- bind_rows(location_main_util_hour, location_sub_util_hour)
# location_util_dur_merged$Days <- weekdays_quarter$days[match(location_util_dur_merged$Appt.Day, weekdays_quarter$Appt.Day)]
# location_util_dur_merged <- location_util_dur_merged %>%
#   mutate(avg_dur = round(total_dur/Days)) 
# location_util_dur_merged <- merge(location_util_dur_merged, location_room_count, all.x = TRUE)
# 
#   
# location_util_dur_summary <- location_util_dur_merged %>%
#   group_by(Appt.YearQtr, `Building Address`, Floor, Visit.Method, Session) %>%
#   summarise(avg_dur = sum(avg_dur))
# location_util_dur_summary <- merge(location_util_dur_summary, location_room_count, all.x = TRUE)
# 
# 
# location_util_dur_summary <- location_util_dur_summary %>%
#   pivot_wider(names_from = "Visit.Method",
#               values_from = "avg_dur",
#               values_fill = 0) %>%
#   mutate(ALL = `IN PERSON` + TELEHEALTH) %>%
#   pivot_longer(`IN PERSON`:ALL,
#                names_to = "Visit.Method",
#                values_to = "avg_dur") %>%
#   pivot_wider(names_from = "Session",
#               values_from = "avg_dur",
#               values_fill = 0) %>%
#   mutate(Day = AM + PM) %>%
#   pivot_longer(AM:Day,
#                names_to = "Session",
#                values_to = "avg_dur") 
# 
# 
# # location_util_dur_merged <- location_util_dur_merged %>%
# #   pivot_wider(names_from = "Visit.Method",
# #               values_from = "avg_dur",
# #               values_fill = 0) %>%
# #   mutate(ALL = `IN PERSON` + TELEHEALTH) %>%
# #   pivot_longer(`IN PERSON`:ALL,
# #                names_to = "Visit.Method",
# #                values_to = "avg_dur") %>%
# #   pivot_wider(names_from = "Session",
# #               values_from = "avg_dur",
# #               values_fill = 0) %>%
# #   mutate(Day = AM + PM) %>%
# #   pivot_longer(AM:Day,
# #                names_to = "Session",
# #                values_to = "avg_dur") 

```


```{r Provider Turns Utilization, echo = FALSE, warning = FALSE, message = FALSE}

# provider_util_turns_summary <- scheduling_data_raw %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Appt.YearQtr == "2022 Q2") %>%
#   filter(Appt.DateYear <= max(Appt.Made.DateYear)) %>%
#   filter(Appt.Day %in% c("Mon","Tue","Wed","Thu","Fri")) %>%
#   group_by(Campus, Campus.Specialty, Department, Provider, Appt.YearQtr, Appt.DateYear, Visit.Method, Session) %>%
#   summarise(daily_vol = n()) %>%
#   group_by(Campus, Campus.Specialty, Department, Provider, Appt.YearQtr, Visit.Method, Session) %>%
#   summarise(avg_vol = round(mean(daily_vol))) 
# 
# 
# provider_util_turns_summary <- provider_util_turns_summary %>%
#   pivot_wider(names_from = "Visit.Method",
#               values_from = "avg_vol",
#               values_fill = 0) %>%
#   mutate(ALL = `IN PERSON` + TELEHEALTH) %>%
#   pivot_longer(`IN PERSON`:ALL,
#                names_to = "Visit.Method",
#                values_to = "avg_vol") %>%
#   pivot_wider(names_from = "Session",
#               values_from = "avg_vol",
#               values_fill = 0) %>%
#   mutate(Day = AM + PM) %>%
#   pivot_longer(AM:Day,
#                names_to = "Session",
#                values_to = "avg_vol") 
# 
# 
# provider_util_turns_summary$Benchmark <- visits_room_day_benchmarks$Benchmark[match(provider_util_turns_summary$Campus.Specialty,
#                                                                              visits_room_day_benchmarks$Campus.Specialty)]
# 
# provider_util_turns_summary <- provider_util_turns_summary %>%
#   mutate(Benchmark = ifelse(Session == "Day", Benchmark, Benchmark/2))

```


```{r Provider Durations Utilization, echo = FALSE, warning = FALSE, message = FALSE}

# provider_util_dur_merged <- util_data_raw %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Appt.YearQtr == "2022 Q2") %>%
#   filter(Appt.Day %in% c("Mon","Tue","Wed","Thu","Fri")) %>%
#   dplyr::select(Campus, Campus.Specialty, Department, Provider, Appt.YearQtr, Appt.DateYear, Appt.Day, 
#                 Visit.Method, `08:00`:`19:00`) %>%
#   pivot_longer(`08:00`:`19:00`,
#                names_to = "space_time",
#                values_to = "space_dur") %>%
#   mutate(Session = ifelse(as.integer(sub(':.*', '', space_time)) >= 12, 'PM', 'AM')) %>%
#   group_by(Campus, Campus.Specialty, Department, Provider, Appt.YearQtr, Appt.DateYear, Appt.Day, 
#            Visit.Method, Session, space_time) %>%
#   summarise(total_dur = round(sum(space_dur)))  %>%
#   group_by(Campus, Campus.Specialty, Department, Provider, Appt.YearQtr, Appt.Day, 
#            Visit.Method, Session, space_time) %>%
#   summarise(avg_dur = round(mean(total_dur)))
# 
# 
# provider_util_dur_summary <- util_data_raw %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Appt.YearQtr == "2022 Q2") %>%
#   filter(Appt.Day %in% c("Mon","Tue","Wed","Thu","Fri")) %>%
#   dplyr::select(Campus, Campus.Specialty, Department, Provider, Appt.YearQtr, Appt.DateYear, Appt.Day,
#                 Visit.Method, `08:00`:`19:00`) %>%
#   pivot_longer(`08:00`:`19:00`,
#                names_to = "space_time",
#                values_to = "space_dur") %>%
#   mutate(Session = ifelse(as.integer(sub(':.*', '', space_time)) >= 12, 'PM', 'AM')) %>%
#   group_by(Campus, Campus.Specialty, Department, Provider, Appt.YearQtr, Appt.DateYear, 
#            Visit.Method, Session) %>%
#   summarise(total_dur = round(sum(space_dur)))  %>%
#   group_by(Campus, Campus.Specialty, Department, Provider, Appt.YearQtr,
#            Visit.Method, Session) %>%
#   summarise(avg_dur = round(mean(total_dur)))
# 
# 
# provider_util_dur_summary <- provider_util_dur_summary %>%
#   pivot_wider(names_from = "Visit.Method",
#               values_from = "avg_dur",
#               values_fill = 0) %>%
#   mutate(ALL = `IN PERSON` + TELEHEALTH) %>%
#   pivot_longer(`IN PERSON`:ALL,
#                names_to = "Visit.Method",
#                values_to = "avg_dur") %>%
#   pivot_wider(names_from = "Session",
#               values_from = "avg_dur",
#               values_fill = 0) %>%
#   mutate(Day = AM + PM) %>%
#   pivot_longer(AM:Day,
#                names_to = "Session",
#                values_to = "avg_dur") 

```


```{r Provider Booked and Filled Hours, echo = FALSE, warning = FALSE, message = FALSE}

# provider_slot_summary <- slot_data_raw %>%
#   group_by(Campus, Campus.Specialty, Department, Provider, Appt.YearQtr, Appt.DateYear, Appt.Day, Session) %>%
#   summarise(`Available Hours` = sum(`Available Hours`),
#             `Booked Hours` = sum(`Booked Hours`),
#             `Arrived Hours` = sum(`Arrived Hours`)) %>%
#   group_by(Campus, Campus.Specialty, Department, Provider, Appt.YearQtr, Appt.Day, Session) %>%
#   summarise(avg_available = round(mean(`Available Hours`),1),
#             avg_booked = round(mean(`Booked Hours`),1),
#             avg_arrived = round(mean(`Arrived Hours`),1),
#             booked_rate = round(avg_booked/avg_available,2),
#             filled_rate = round(avg_arrived/avg_available,2))

```


```{r Output Utilization Data Tables, echo = FALSE, warning = FALSE, message = FALSE}

# Referrals Tables -------------------------------------------------------------
saveRDS(monthly_referral_vol, "/nfs/data/Applications/Ambulatory/Quarterly_Data/monthly_referral_vol.rds")


# Volume Tables ----------------------------------------------------------------
## Arrived monthly volume ======================================================
saveRDS(monthly_vol, "/nfs/data/Applications/Ambulatory/Quarterly_Data/monthly_vol.rds")
## Arrived Epic department quarterly volume ====================================
saveRDS(vol_zip_code, "/nfs/data/Applications/Ambulatory/Quarterly_Data/vol_zip_code.rds")

# Access Tables ----------------------------------------------------------------
## Wait Time Horizon by Specialty
saveRDS(waitTime_dist_specialty, "/nfs/data/Applications/Ambulatory/Quarterly_Data/waitTime_dist_specialty.rds")
saveRDS(waitTime_dist_site, "/nfs/data/Applications/Ambulatory/Quarterly_Data/waitTime_dist_site.rds")

## Median Wait Time
saveRDS(waitTime_mshs, "/nfs/data/Applications/Ambulatory/Quarterly_Data/waitTime_mshs.rds") # By MSHS Specialty (Exc. MSDD and Network)
saveRDS(waitTime_site, "/nfs/data/Applications/Ambulatory/Quarterly_Data/waitTime_site.rds") # By Specialty and Site
saveRDS(waitTime_prov, "/nfs/data/Applications/Ambulatory/Quarterly_Data/waitTime_prov.rds") # By Specialty and Provider

# Payor Mix Table --------------------------------------------------------------
saveRDS(payer_mix_quarter_site, "/nfs/data/Applications/Ambulatory/Quarterly_Data/payer_mix_quarter_site.rds")


# # Utilization Data -------------------------------------------------------------
# ## Location=====================================================================
# saveRDS(location_util_turns_merged, "locations_util_turns_merged.rds") # By Turns
# saveRDS(location_util_turns_summary, "locations_util_turns_summary.rds") # By Turns
# 
# saveRDS(location_util_dur_merged, "locations_util_dur_merged.rds") # By Durations
# saveRDS(location_util_dur_summary, "locations_util_dur_summary.rds") # By Durations
# 
# ## Provider ====================================================================
# saveRDS(provider_util_turns_summary, "provider_util_turns_summary.rds") # By Turns
# saveRDS(provider_util_dur_summary, "provider_util_dur_summary.rds") # By Turns
# saveRDS(provider_util_dur_merged, "provider_util_dur_merged.rds") # By Turns
# 
# # Slot Data --------------------------------------------------------------------
# ## Provider ====================================================================
# saveRDS(provider_slot_summary, "provider_slot_summary.rds")
# 
# # Room Inventory ----------------------------------------------------------------
# saveRDS(pt_rooms_summary, "pt_rooms_summary.rds")

```
